name: 3. Auto-Merge Version PR

on:
  pull_request:
    types: [opened, synchronize, reopened]
  pull_request_review:
    types: [submitted]
  check_suite:
    types: [completed]
  workflow_run:
    workflows: ['1. Validate PR (Lint, Test, Build)']
    types: [completed]

permissions:
  contents: write
  pull-requests: write
  checks: read

jobs:
  auto-merge:
    name: Auto-merge version bump PRs
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'pull_request' || 
       github.event_name == 'pull_request_review' ||
       github.event_name == 'check_suite' ||
       github.event_name == 'workflow_run')

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Get PR number
        id: pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=""

          if [ "${{ github.event_name }}" = "pull_request" ]; then
            PR_NUMBER="${{ github.event.pull_request.number }}"
          elif [ "${{ github.event_name }}" = "pull_request_review" ]; then
            PR_NUMBER="${{ github.event.pull_request.number }}"
          elif [ "${{ github.event_name }}" = "workflow_run" ] && [ -n "${{ github.event.workflow_run.pull_requests[0].number }}" ]; then
            PR_NUMBER="${{ github.event.workflow_run.pull_requests[0].number }}"
          elif [ "${{ github.event_name }}" = "check_suite" ] && [ -n "${{ github.event.check_suite.pull_requests[0].number }}" ]; then
            PR_NUMBER="${{ github.event.check_suite.pull_requests[0].number }}"
          fi

          if [ -z "$PR_NUMBER" ]; then
            echo "‚ÑπÔ∏è No PR found for this event"
            echo "found=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "found=true" >> $GITHUB_OUTPUT
          echo "üîç Checking PR #${PR_NUMBER}"

      - name: Check if version bump PR
        id: check
        if: steps.pr.outputs.found == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ steps.pr.outputs.number }}"
          WORKFLOW_PAT_OWNER="${{ vars.WORKFLOW_PAT_OWNER || 'thoroc' }}"

          # Get PR details
          PR_DATA=$(gh pr view $PR_NUMBER --json title,author,headRefName,state,labels)

          PR_TITLE=$(echo "$PR_DATA" | jq -r '.title')
          PR_AUTHOR=$(echo "$PR_DATA" | jq -r '.author.login')
          PR_BRANCH=$(echo "$PR_DATA" | jq -r '.headRefName')
          PR_STATE=$(echo "$PR_DATA" | jq -r '.state')
          PR_LABELS=$(echo "$PR_DATA" | jq -r '.labels[].name' | tr '\n' ',' | sed 's/,$//')

          echo "üìã PR Details:"
          echo "  Title: $PR_TITLE"
          echo "  Author: $PR_AUTHOR"
          echo "  Branch: $PR_BRANCH"
          echo "  State: $PR_STATE"
          echo "  Labels: $PR_LABELS"
          echo "  Allowed PAT Owner: $WORKFLOW_PAT_OWNER"

          # Check if this is a version bump PR
          IS_VERSION_PR=false

          # Accept PRs from github-actions[bot] or the WORKFLOW_PAT user (configurable)
          if [[ "$PR_TITLE" =~ ^chore:\ bump\ version\ to\ v[0-9]+\.[0-9]+\.[0-9]+$ ]] && \
             [[ "$PR_BRANCH" =~ ^version-bump/ ]] && \
             ( [[ "$PR_AUTHOR" == "github-actions[bot]" ]] || [[ "$PR_AUTHOR" == "$WORKFLOW_PAT_OWNER" ]] ) && \
             [[ "$PR_STATE" == "OPEN" ]]; then
            IS_VERSION_PR=true
          fi

          if [ "$IS_VERSION_PR" = "true" ]; then
            echo "‚úÖ This is a version bump PR"
            echo "is_version_pr=true" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Not a version bump PR"
            echo "is_version_pr=false" >> $GITHUB_OUTPUT
          fi

      - name: Check PR status
        id: status
        if: steps.pr.outputs.found == 'true' && steps.check.outputs.is_version_pr == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ steps.pr.outputs.number }}"
          MAX_RETRIES=3
          RETRY_DELAY=30
          ATTEMPT=1

          while [ $ATTEMPT -le $MAX_RETRIES ]; do
            echo "üîÑ Attempt $ATTEMPT of $MAX_RETRIES..."

            # Check mergability
            MERGEABLE=$(gh pr view $PR_NUMBER --json mergeable --jq '.mergeable')

            if [ "$MERGEABLE" != "MERGEABLE" ]; then
              echo "‚ö†Ô∏è PR is not mergeable (status: $MERGEABLE)"
              
              if [ $ATTEMPT -lt $MAX_RETRIES ]; then
                echo "‚è≥ Waiting ${RETRY_DELAY}s before retry..."
                sleep $RETRY_DELAY
                ATTEMPT=$((ATTEMPT + 1))
                continue
              else
                echo "ready=false" >> $GITHUB_OUTPUT
                echo "reason=not_mergeable" >> $GITHUB_OUTPUT
                exit 0
              fi
            fi

            # Check all required checks
            # Note: gh pr checks only supports state field, not conclusion
            # state can be: failure, pending, success
            CHECKS=$(gh pr checks $PR_NUMBER --json state,bucket 2>/dev/null || echo '[]')

            FAILED_CHECKS=$(echo "$CHECKS" | jq '[.[] | select(.state == "failure")] | length')
            PENDING_CHECKS=$(echo "$CHECKS" | jq '[.[] | select(.state == "pending")] | length')

            if [ "$FAILED_CHECKS" -gt 0 ]; then
              echo "‚ùå Some checks failed ($FAILED_CHECKS failures)"
              echo "ready=false" >> $GITHUB_OUTPUT
              echo "reason=failed_checks" >> $GITHUB_OUTPUT
              exit 0
            fi

            if [ "$PENDING_CHECKS" -gt 0 ]; then
              echo "‚è≥ Some checks are still pending ($PENDING_CHECKS pending)"
              
              if [ $ATTEMPT -lt $MAX_RETRIES ]; then
                echo "‚è≥ Waiting ${RETRY_DELAY}s for checks to complete..."
                sleep $RETRY_DELAY
                ATTEMPT=$((ATTEMPT + 1))
                continue
              else
                echo "ready=false" >> $GITHUB_OUTPUT
                echo "reason=pending_checks" >> $GITHUB_OUTPUT
                exit 0
              fi
            fi

            # All checks passed!
            echo "‚úÖ All checks passed - ready to merge"
            echo "ready=true" >> $GITHUB_OUTPUT
            exit 0
          done

          # Should not reach here, but just in case
          echo "‚ö†Ô∏è Maximum retries exceeded"
          echo "ready=false" >> $GITHUB_OUTPUT
          echo "reason=max_retries" >> $GITHUB_OUTPUT

      - name: Enable auto-merge
        if: steps.pr.outputs.found == 'true' && steps.check.outputs.is_version_pr == 'true' && steps.status.outputs.ready == 'true'
        env:
          GH_TOKEN: ${{ secrets.WORKFLOW_PAT || secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ steps.pr.outputs.number }}"

          echo "üéØ Enabling auto-merge for PR #${PR_NUMBER}"

          # Enable auto-merge with squash
          gh pr merge $PR_NUMBER --squash --auto --delete-branch

          echo "‚úÖ Auto-merge enabled!"

          # Add comment
          gh pr comment $PR_NUMBER --body "üéâ **Auto-merge enabled!**

          This version bump PR will be automatically merged once all checks pass.

          **Next Steps:**
          - üè∑Ô∏è Git tag will be created automatically
          - üì¶ npm package will be published
          - üìö Documentation will be deployed

          *This action was performed by the Auto-Merge workflow.*"

      - name: Comment on failed checks
        if: steps.pr.outputs.found == 'true' && steps.check.outputs.is_version_pr == 'true' && steps.status.outputs.ready == 'false' && steps.status.outputs.reason == 'failed_checks'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ steps.pr.outputs.number }}"

          gh pr comment $PR_NUMBER --body "‚ùå **Auto-merge blocked**

          This version bump PR has failing checks and cannot be automatically merged.

          Please review the failed checks and address any issues, or merge manually if the failures are acceptable.

          *This message was generated by the Auto-Merge workflow.*"

      - name: Comment on pending checks timeout
        if: steps.pr.outputs.found == 'true' && steps.check.outputs.is_version_pr == 'true' && steps.status.outputs.ready == 'false' && steps.status.outputs.reason == 'pending_checks'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ steps.pr.outputs.number }}"

          gh pr comment $PR_NUMBER --body "‚è≥ **Auto-merge delayed**

          This version bump PR still has pending checks after waiting.

          The workflow will retry when checks complete. You can also manually merge once all checks pass.

          *This message was generated by the Auto-Merge workflow.*"

      - name: Summary
        if: always()
        run: |
          if [ "${{ steps.pr.outputs.found }}" != "true" ]; then
            echo "‚ÑπÔ∏è No PR found for this event"
          elif [ "${{ steps.check.outputs.is_version_pr }}" != "true" ]; then
            echo "‚ÑπÔ∏è Not a version bump PR - skipping"
          elif [ "${{ steps.status.outputs.ready }}" = "true" ]; then
            echo "‚úÖ Auto-merge enabled for PR #${{ steps.pr.outputs.number }}"
          elif [ "${{ steps.status.outputs.reason }}" = "pending_checks" ]; then
            echo "‚è≥ Checks still pending after retries - will retry later"
          elif [ "${{ steps.status.outputs.reason }}" = "failed_checks" ]; then
            echo "‚ùå Checks failed - cannot auto-merge"
          elif [ "${{ steps.status.outputs.reason }}" = "not_mergeable" ]; then
            echo "‚ö†Ô∏è PR not mergeable after retries"
          else
            echo "‚ö†Ô∏è PR not ready to merge"
          fi
