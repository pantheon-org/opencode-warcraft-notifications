name: Chores ‚Äî Repository Configuration

on:
  workflow_dispatch:
  schedule:
    # Check configuration weekly on Mondays at 9 AM UTC
    - cron: '0 9 * * 1'
  push:
    paths:
      - '.github/scripts/check-repo-config.cjs'
      - '.github/workflows/chores-repo-config.yml'

permissions:
  contents: read
  pull-requests: read
  issues: write

jobs:
  check-config:
    name: Verify Repository Configuration
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup Node.js
        uses: actions/setup-node@39370e3970a6d050c480ffad4ff0ed4d3fdee5af # v4.1.0
        with:
          node-version: '20'

      - name: Setup GitHub CLI
        run: gh --version

      - name: Run repository configuration check
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üîç Running repository configuration check..."
          node .github/scripts/check-repo-config.cjs

      - name: Create issue on configuration problems
        if: failure()
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7.1.0
        with:
          script: |
            // Check if there's already an open issue
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'configuration,automation'
            });

            const existingIssue = issues.find(issue => 
              issue.title.includes('Repository Configuration')
            );

            if (existingIssue) {
              console.log(`Issue already exists: #${existingIssue.number}`);
              return;
            }

            // Create new issue
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'üîß Repository Configuration: Squash Merge Required',
              labels: ['configuration', 'automation'],
              body: `## Issue

              The repository configuration check detected settings that may allow multiple releases per merge request.

              ## Problem

              Our workflow requires **squash merges only** to ensure:
              - One commit per PR merge
              - One version bump per merge
              - One release per version

              ## Required Configuration

              Go to [Repository Settings](https://github.com/${context.repo.owner}/${context.repo.repo}/settings) ‚Üí **General ‚Üí Pull Requests**:

              ### Merge Settings
              - ‚úÖ **Enable** "Allow squash merging"
              - ‚ùå **Disable** "Allow merge commits"
              - ‚ùå **Disable** "Allow rebase merging"
              - ‚úÖ **Enable** "Automatically delete head branches"

              ## Verification

              After making changes, run:
              \`\`\`bash
              node .github/scripts/check-repo-config.cjs
              \`\`\`

              Or trigger the workflow manually:
              \`\`\`bash
              gh workflow run chores-repo-config.yml
              \`\`\`

              ## Why This Matters

              Without squash merge enforcement:
              - Multiple commits in a PR create multiple tags
              - Multiple tags trigger multiple releases
              - Release history becomes cluttered
              - Version numbers become unpredictable

              ## Documentation

              - [Workflow Documentation](.github/WORKFLOWS.md)
              - [Repository Configuration Script](.github/scripts/check-repo-config.cjs)

              ---

              *This issue was automatically created by the Repository Configuration Check workflow.*  
              *Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}*`
            });

      - name: Summary
        if: always()
        run: |
          echo "üìä Repository Configuration Check Complete"
          echo ""
          echo "üéØ Goal: Ensure single release per merge request"
          echo "üîß Method: Enforce squash merge strategy"
          echo ""
          echo "For manual configuration:"
          echo "https://github.com/${{ github.repository }}/settings"
          echo ""
          echo "Documentation: .github/WORKFLOWS.md"
