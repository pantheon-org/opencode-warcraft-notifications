name: Copilot Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR number to review (leave empty for all open PRs)'
        required: false
        type: string

permissions:
  contents: read
  pull-requests: write

concurrency:
  group: copilot-review-${{ github.event.pull_request.number || github.run_id }}
  cancel-in-progress: true

jobs:
  request-review:
    name: Request Copilot Review
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get PR number
        id: pr
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            PR_NUMBER="${{ github.event.pull_request.number }}"
          elif [ -n "${{ github.event.inputs.pr_number }}" ]; then
            PR_NUMBER="${{ github.event.inputs.pr_number }}"
          else
            # Get all open PRs
            PR_NUMBER=$(gh pr list --json number --jq '.[0].number')
          fi

          echo "number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "üìù Processing PR #${PR_NUMBER}"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Check PR state
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ steps.pr.outputs.number }}"

          # Get PR details
          PR_STATE=$(gh pr view $PR_NUMBER --json state --jq '.state')
          PR_TITLE=$(gh pr view $PR_NUMBER --json title --jq '.title')
          PR_AUTHOR=$(gh pr view $PR_NUMBER --json author --jq '.author.login')
          PR_DRAFT=$(gh pr view $PR_NUMBER --json isDraft --jq '.isDraft')

          echo "üîç PR Details:"
          echo "  Title: $PR_TITLE"
          echo "  Author: $PR_AUTHOR"
          echo "  State: $PR_STATE"
          echo "  Draft: $PR_DRAFT"

          if [ "$PR_STATE" != "OPEN" ]; then
            echo "‚ö†Ô∏è PR is not open (state: $PR_STATE)"
            echo "reviewable=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Skip draft PRs unless explicitly requested
          if [ "$PR_DRAFT" = "true" ] && [ "${{ github.event_name }}" != "workflow_dispatch" ]; then
            echo "‚ö†Ô∏è Skipping draft PR (trigger manually if needed)"
            echo "reviewable=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Skip bot PRs from our own automation
          if [[ "$PR_AUTHOR" == "github-actions[bot]" ]] && [[ "$PR_TITLE" =~ ^chore:\ bump\ version ]]; then
            echo "‚ö†Ô∏è Skipping automated version bump PR"
            echo "reviewable=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "reviewable=true" >> $GITHUB_OUTPUT

      - name: Check if Copilot already reviewed
        id: existing
        if: steps.check.outputs.reviewable == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ steps.pr.outputs.number }}"

          # Check for existing Copilot reviews
          REVIEW_COUNT=$(gh api repos/${{ github.repository }}/pulls/$PR_NUMBER/reviews \
            --jq '[.[] | select(.user.login == "copilot[bot]")] | length')

          if [ "$REVIEW_COUNT" -gt 0 ]; then
            echo "‚ÑπÔ∏è Copilot has already reviewed this PR ($REVIEW_COUNT review(s))"
            
            # Only skip if this is not a new push (synchronize event)
            if [ "${{ github.event.action }}" != "synchronize" ]; then
              echo "skip=true" >> $GITHUB_OUTPUT
              exit 0
            fi
            
            echo "üîÑ New changes detected - requesting re-review"
          fi

          echo "skip=false" >> $GITHUB_OUTPUT

      - name: Request Copilot Review
        if: steps.check.outputs.reviewable == 'true' && steps.existing.outputs.skip != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ steps.pr.outputs.number }}"

          echo "ü§ñ Requesting GitHub Copilot code review for PR #${PR_NUMBER}"

          # Try to add Copilot as reviewer
          if gh pr edit $PR_NUMBER --add-reviewer copilot 2>/dev/null; then
            echo "‚úÖ Copilot review requested successfully!"
            
            # Add informative comment
            gh pr comment $PR_NUMBER --body "## ü§ñ GitHub Copilot Review Requested
            
            **Status:** ‚è≥ Review in progress...
            
            GitHub Copilot is now analyzing this pull request and will provide feedback shortly.
            
            ### What to expect:
            - üìù Review typically completes in **~30 seconds**
            - üîç Copilot will comment on:
              - Potential bugs and security issues
              - Code quality improvements
              - Testing recommendations
              - Project-specific concerns (see [\`.github/copilot-instructions.md\`](../blob/main/.github/copilot-instructions.md))
            - ‚ú® Suggested changes can be applied with **one click**
            - üîÑ Re-review will be triggered on new pushes
            
            ### Important Notes:
            - ‚ö†Ô∏è This is an **AI-powered review** - human review is still recommended
            - ‚ÑπÔ∏è Copilot reviews are **non-blocking** and won't prevent merging
            - üëçüëé Please provide feedback on review comments to improve quality
            
            ---
            *Automated by the Copilot Code Review workflow* | [Learn more](../blob/main/AI_CODE_REVIEWERS_GUIDE.md)"
            
          else
            echo "‚ö†Ô∏è Failed to add Copilot as reviewer"
            echo "üí° Copilot may not be enabled for this repository"
            
            # Check if this is the first time
            COMMENT_EXISTS=$(gh pr view $PR_NUMBER --json comments \
              --jq '[.comments[] | select(.body | contains("Copilot Review Not Available"))] | length')
            
            if [ "$COMMENT_EXISTS" -eq 0 ]; then
              gh pr comment $PR_NUMBER --body "## ‚ö†Ô∏è Copilot Review Not Available
              
              GitHub Copilot code review could not be requested for this PR.
              
              ### Possible reasons:
              1. GitHub Copilot is not enabled for this repository
              2. The repository doesn't have a Copilot subscription
              3. Copilot is not configured as an available reviewer
              
              ### To enable automatic AI code reviews:
              
              #### For Repository Admins:
              1. Ensure your organization has a **GitHub Copilot Business** or **Enterprise** subscription
              2. Go to **Repository Settings** ‚Üí **Code review**
              3. Enable **GitHub Copilot** as a reviewer
              4. Configure automatic review triggers (optional)
              
              #### Manual Alternative:
              You can manually add Copilot as a reviewer from the **Reviewers** section in the PR sidebar.
              
              #### Other Options:
              See [AI_CODE_REVIEWERS_GUIDE.md](../blob/main/AI_CODE_REVIEWERS_GUIDE.md) for alternative AI code review solutions including:
              - Third-party GitHub Marketplace apps
              - Custom integrations with Claude or Gemini
              - Self-hosted solutions
              
              ---
              *Automated by the Copilot Code Review workflow*"
            fi
            
            exit 1
          fi

      - name: Wait for Copilot Review
        if: steps.check.outputs.reviewable == 'true' && steps.existing.outputs.skip != 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ steps.pr.outputs.number }}"
          MAX_WAIT=90  # Wait up to 90 seconds
          WAIT_TIME=0
          CHECK_INTERVAL=10

          echo "‚è≥ Waiting for Copilot to complete review..."

          while [ $WAIT_TIME -lt $MAX_WAIT ]; do
            # Check if Copilot has submitted a new review
            RECENT_REVIEWS=$(gh api repos/${{ github.repository }}/pulls/$PR_NUMBER/reviews \
              --jq '[.[] | select(.user.login == "copilot[bot]" and (.submitted_at | fromdateiso8601) > (now - 120))] | length')
            
            if [ "$RECENT_REVIEWS" -gt 0 ]; then
              echo "‚úÖ Copilot review completed!"
              
              # Get review summary
              REVIEW_DATA=$(gh api repos/${{ github.repository }}/pulls/$PR_NUMBER/reviews \
                --jq '[.[] | select(.user.login == "copilot[bot]")] | sort_by(.submitted_at) | last')
              
              COMMENT_COUNT=$(echo "$REVIEW_DATA" | jq -r '.body | length')
              
              echo "üìä Review Summary:"
              echo "  Comments: $COMMENT_COUNT characters"
              echo "  Time taken: ~$WAIT_TIME seconds"
              
              exit 0
            fi
            
            sleep $CHECK_INTERVAL
            WAIT_TIME=$((WAIT_TIME + CHECK_INTERVAL))
            echo "‚è≥ Still waiting... ($WAIT_TIME/$MAX_WAIT seconds)"
          done

          echo "‚ö†Ô∏è Copilot review taking longer than expected ($MAX_WAIT seconds)"
          echo "üí° The review may still complete - check the PR shortly"
          echo "üîÑ If no review appears, try re-triggering this workflow manually"

      - name: Update status comment
        if: always() && steps.check.outputs.reviewable == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ steps.pr.outputs.number }}"

          # Find the bot's comment about review request
          COMMENT_ID=$(gh api repos/${{ github.repository }}/issues/$PR_NUMBER/comments \
            --jq '[.[] | select(.user.login == "github-actions[bot]" and (.body | contains("Copilot Review Requested")))] | sort_by(.created_at) | last | .id')

          if [ -n "$COMMENT_ID" ] && [ "$COMMENT_ID" != "null" ]; then
            echo "üìù Updating status comment #$COMMENT_ID"
            
            gh api repos/${{ github.repository }}/issues/comments/$COMMENT_ID \
              -X PATCH \
              -f body="## ‚úÖ GitHub Copilot Review Complete
              
              GitHub Copilot has finished analyzing this pull request.
              
              ### Review Status:
              - ‚úÖ **Complete** - Check the 'Files changed' tab for Copilot's comments
              - üîç Review the feedback and apply suggested changes as appropriate
              - üëçüëé Please provide feedback on review comments to improve quality
              
              ### Next Steps:
              1. Review Copilot's feedback in the **Files changed** tab
              2. Apply relevant suggestions (click **Commit suggestion** on review comments)
              3. Address any issues flagged by Copilot
              4. Request human review for final approval
              
              ### Notes:
              - ‚ö†Ô∏è This is an **AI-powered review** - always use human judgment
              - üîÑ Copilot will automatically re-review when you push new changes
              - ‚ÑπÔ∏è Copilot reviews are **non-blocking** and won't prevent merging
              
              ---
              *Automated by the Copilot Code Review workflow* | [Learn more](../blob/main/AI_CODE_REVIEWERS_GUIDE.md)" \
              2>/dev/null || echo "‚ö†Ô∏è Could not update comment"
          fi

  summary:
    name: Review Summary
    runs-on: ubuntu-latest
    needs: request-review
    if: always()

    steps:
      - name: Generate Summary
        run: |
          echo "## ü§ñ Copilot Code Review Workflow"
          echo ""

          if [ "${{ needs.request-review.result }}" = "success" ]; then
            echo "‚úÖ **Status:** Review requested successfully"
            echo ""
            echo "GitHub Copilot is analyzing the PR and will provide feedback shortly."
            echo "Check the PR for Copilot's review comments."
          elif [ "${{ needs.request-review.result }}" = "skipped" ]; then
            echo "‚ÑπÔ∏è **Status:** Review skipped"
            echo ""
            echo "Possible reasons:"
            echo "- PR is not in a reviewable state"
            echo "- Copilot has already reviewed this PR"
            echo "- PR is from automation (version bump)"
          else
            echo "‚ö†Ô∏è **Status:** Review request failed"
            echo ""
            echo "Copilot review could not be requested."
            echo "Check workflow logs for details."
            echo ""
            echo "See [AI_CODE_REVIEWERS_GUIDE.md](AI_CODE_REVIEWERS_GUIDE.md) for setup instructions."
          fi
