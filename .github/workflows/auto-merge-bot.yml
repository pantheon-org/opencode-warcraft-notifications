name: Auto-Merge Bot

on:
  pull_request:
    types: [opened, synchronize, reopened]
  check_suite:
    types: [completed]
  workflow_run:
    workflows: ["PR Validation"] 
    types: [completed]

permissions:
  contents: write
  pull-requests: write
  checks: read

jobs:
  auto-merge:
    name: Auto-merge version sync PRs
    runs-on: ubuntu-latest
    
    steps:
      - name: Get PR number from different event types
        id: get-pr
        uses: actions/github-script@v7
        with:
          script: |
            let prNumber = null;
            
            if (context.eventName === 'pull_request') {
              prNumber = context.payload.pull_request.number;
            } else if (context.eventName === 'workflow_run' && context.payload.workflow_run.pull_requests.length > 0) {
              prNumber = context.payload.workflow_run.pull_requests[0].number;
            } else if (context.eventName === 'check_suite' && context.payload.check_suite.pull_requests.length > 0) {
              prNumber = context.payload.check_suite.pull_requests[0].number;
            }
            
            if (!prNumber) {
              console.log('No PR found for this event');
              return;
            }
            
            core.setOutput('pr_number', prNumber);
            return prNumber;

      - name: Check PR and auto-merge if eligible
        if: steps.get-pr.outputs.pr_number
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = parseInt('${{ steps.get-pr.outputs.pr_number }}');
            
            // Get PR details
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });
            
            console.log(\`Checking PR #\${prNumber}: \${pr.title}\`);
            console.log(\`Author: \${pr.user.login}\`);
            console.log(\`Branch: \${pr.head.ref}\`);
            console.log(\`State: \${pr.state}\`);
            
            // Check if this is a version sync PR that should be auto-merged
            const isVersionSyncPR = (
              pr.title.match(/^chore: sync package\.json version to \d+\.\d+\.\d+$/) &&
              pr.head.ref.startsWith('sync-version/') &&
              pr.user.login === 'github-actions[bot]' &&
              pr.state === 'open'
            );
            
            if (!isVersionSyncPR) {
              console.log('‚ùå Not a version sync PR - skipping auto-merge');
              return;
            }
            
            console.log('‚úÖ This is a version sync PR - checking if ready to merge');
            
            // Get the latest commit SHA
            const headSha = pr.head.sha;
            
            // Check all status checks
            const { data: checkRuns } = await github.rest.checks.listForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: headSha
            });
            
            const { data: statuses } = await github.rest.repos.listCommitStatusesForRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: headSha
            });
            
            console.log(\`Found \${checkRuns.check_runs.length} check runs and \${statuses.length} statuses\`);
            
            // Check if all checks are successful
            const allCheckRunsPass = checkRuns.check_runs.length === 0 || checkRuns.check_runs.every(check => 
              check.status === 'completed' && check.conclusion === 'success'
            );
            
            const allStatusesPass = statuses.length === 0 || statuses.every(status => 
              status.state === 'success'
            );
            
            const hasFailedChecks = checkRuns.check_runs.some(check => 
              check.status === 'completed' && (check.conclusion === 'failure' || check.conclusion === 'cancelled')
            ) || statuses.some(status => status.state === 'failure' || status.state === 'error');
            
            const hasPendingChecks = checkRuns.check_runs.some(check => 
              check.status === 'in_progress' || check.status === 'queued'
            ) || statuses.some(status => status.state === 'pending');
            
            if (hasFailedChecks) {
              console.log('‚ùå Some checks failed - will not auto-merge');
              
              // Add comment about failed checks
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: \`‚ùå **Auto-merge blocked**

This version sync PR has failing checks and will not be automatically merged.

Please review the failed checks and address any issues, or merge manually if the failures are acceptable.

*This message was generated by the Auto-Merge Bot.*\`
              });
              return;
            }
            
            if (hasPendingChecks) {
              console.log('‚è≥ Some checks are still pending - waiting');
              return;
            }
            
            if (!allCheckRunsPass || !allStatusesPass) {
              console.log('‚è≥ Not all checks are completed yet - waiting');
              return;
            }
            
            console.log('üéØ All checks passed - attempting to merge');
            
            try {
              // Attempt to squash merge the PR
              await github.rest.pulls.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                merge_method: 'squash',
                commit_title: \`\${pr.title} (#\${prNumber})\`,
                commit_message: \`\${pr.body || ''}\n\nAuto-merged after successful validation.\`
              });
              
              console.log(\`‚úÖ Successfully auto-merged PR #\${prNumber}\`);
              
              // Add success comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: \`üéâ **Auto-merged successfully!**

This version sync PR has been automatically merged after all checks passed.

**Summary:**
- ‚úÖ All validation checks completed successfully
- ‚úÖ Merged using squash and merge
- üè∑Ô∏è Version sync completed automatically

*This action was performed by the Auto-Merge Bot.*\`
              });
              
            } catch (error) {
              console.error('‚ùå Failed to merge PR:', error);
              
              // Add error comment
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: \`‚ö†Ô∏è **Auto-merge failed**

All checks passed but the automatic merge failed. This may be due to:
- Merge conflicts
- Branch protection rules
- Insufficient permissions

Please merge manually.

Error: \\\`\${error.message}\\\`

*This message was generated by the Auto-Merge Bot.*\`
              });
            }
