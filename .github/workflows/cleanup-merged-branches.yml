name: Cleanup Merged Branches

on:
  pull_request:
    types: [closed]
  schedule:
    # Run weekly cleanup on Sundays at 2 AM UTC
    - cron: '0 2 * * 0'
  workflow_dispatch:
    # Allow manual triggering

permissions:
  contents: write
  pull-requests: read

jobs:
  cleanup-merged-branches:
    name: Delete merged branches
    runs-on: ubuntu-latest
    if: github.event.pull_request.merged == true || github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Delete merged branch (PR trigger)
        if: github.event_name == 'pull_request' && github.event.pull_request.merged == true
        run: |
          BRANCH_NAME="${{ github.event.pull_request.head.ref }}"
          REPO_OWNER="${{ github.event.pull_request.head.repo.owner.login }}"
          CURRENT_REPO_OWNER="${{ github.repository_owner }}"
          
          # Only delete if it's from the same repository (not a fork)
          if [ "$REPO_OWNER" = "$CURRENT_REPO_OWNER" ]; then
            echo "Deleting merged branch: $BRANCH_NAME"
            git push origin --delete "$BRANCH_NAME" || echo "Branch $BRANCH_NAME already deleted or doesn't exist"
          else
            echo "Skipping deletion of fork branch: $BRANCH_NAME"
          fi

      - name: Cleanup stale merged branches (scheduled/manual)
        if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
        run: |
          echo "Fetching all remote branches..."
          git fetch --all --prune
          
          echo "Finding merged branches..."
          # Get all remote branches that have been merged into main
          MERGED_BRANCHES=$(git branch -r --merged origin/main | grep -v 'origin/main' | grep -v 'origin/HEAD' | sed 's/origin\///' | xargs)
          
          if [ -n "$MERGED_BRANCHES" ]; then
            echo "Found merged branches: $MERGED_BRANCHES"
            
            for branch in $MERGED_BRANCHES; do
              # Skip protected branches
              if [[ "$branch" =~ ^(main|master|develop|staging|production)$ ]]; then
                echo "Skipping protected branch: $branch"
                continue
              fi
              
              # Skip branches that are less than 1 day old
              BRANCH_AGE=$(git log -1 --format="%ct" "origin/$branch" 2>/dev/null || echo "0")
              CURRENT_TIME=$(date +%s)
              AGE_DAYS=$(( (CURRENT_TIME - BRANCH_AGE) / 86400 ))
              
              if [ $AGE_DAYS -lt 1 ]; then
                echo "Skipping recently created branch: $branch (age: $AGE_DAYS days)"
                continue
              fi
              
              echo "Deleting stale merged branch: $branch"
              git push origin --delete "$branch" || echo "Failed to delete branch $branch or already deleted"
            done
          else
            echo "No merged branches found to clean up"
          fi

      - name: Cleanup local tracking branches
        if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
        run: |
          echo "Cleaning up local tracking branches for deleted remotes..."
          git remote prune origin
          
          # Remove local branches that no longer have a remote
          git branch -vv | grep ': gone]' | awk '{print $1}' | xargs -r git branch -D || echo "No orphaned local branches found"