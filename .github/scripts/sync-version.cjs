#!/usr/bin/env node

/**
 * Version sync script for package.json
 * Syncs package.json version with Git tags
 */

const { execSync } = require('child_process');
const { readFileSync, writeFileSync } = require('fs');

// Helper function to execute shell commands
function exec(command) {
  try {
    return execSync(command, { encoding: 'utf8', stdio: 'pipe' }).trim();
  } catch (error) {
    console.error(`Command failed: ${command}`);
    console.error(error.message);
    throw error;
  }
}

// Get environment variables
const { GITHUB_TOKEN, GITHUB_REPOSITORY, GITHUB_REF } = process.env;

// Validate required environment variables
if (!GITHUB_TOKEN || !GITHUB_REPOSITORY || !GITHUB_REF) {
  console.error('‚ùå Missing required environment variables');
  process.exit(1);
}

// Extract tag from GITHUB_REF (refs/tags/v1.0.0)
const tagMatch = GITHUB_REF.match(/^refs\/tags\/(.+)$/);
if (!tagMatch) {
  console.error('‚ùå Not triggered by a tag push');
  process.exit(1);
}

const tag = tagMatch[1];
const version = tag.replace(/^v/, '');

console.log(`üè∑Ô∏è Processing tag: ${tag}`);
console.log(`üì¶ Extracted version: ${version}`);

async function main() {
  // Check if this tag was created very recently (potential race condition)
  try {
    const tagDate = exec(`git log -1 --format=%ct ${tag} 2>/dev/null`);
    const currentTime = Math.floor(Date.now() / 1000);
    const tagAge = currentTime - parseInt(tagDate);

    if (tagAge < 30) {
      // Less than 30 seconds old
      console.log(`‚ö†Ô∏è Tag ${tag} is very recent (${tagAge}s old) - potential race condition`);
      console.log('‚è≥ Waiting 30 seconds to ensure tag creation is complete...');
      await new Promise((resolve) => setTimeout(resolve, 30000));
    }
  } catch (error) {
    console.log('‚ÑπÔ∏è Could not determine tag age, proceeding normally');
  }
  // Read current package.json
  let packageJson;
  try {
    packageJson = JSON.parse(readFileSync('package.json', 'utf8'));
  } catch (error) {
    console.error('‚ùå Failed to read package.json');
    process.exit(1);
  }

  const currentVersion = packageJson.version;
  console.log(`üìã Current package.json version: ${currentVersion}`);
  console.log(`üéØ Target version: ${version}`);

  // Check if update is needed
  if (currentVersion === version) {
    console.log('‚úÖ Package.json version already matches tag version - no sync needed');
    console.log('This is expected behavior with the new Smart Version Bump workflow');
    return;
  }

  console.log('üì¶ Package.json needs version update (legacy mode)');

  // Configure Git
  exec('git config --local user.email "action@github.com"');
  exec('git config --local user.name "GitHub Action"');

  // Create version sync branch
  const branchName = `sync-version/${tag}`;
  console.log(`üåø Creating branch: ${branchName}`);

  exec(`git checkout -b "${branchName}"`);

  // Update package.json version
  packageJson.version = version;
  writeFileSync('package.json', JSON.stringify(packageJson, null, 2) + '\n');
  console.log(`‚úèÔ∏è Updated package.json version to: ${version}`);

  // Commit and push version sync
  exec('git add package.json');
  exec(`git commit -m "chore: sync package.json version to ${version} [skip ci]

Automatically generated by tag ${tag}
This commit should not trigger additional workflows.

[skip ci]"`);

  exec(`git push origin "${branchName}"`);
  console.log(`üöÄ Pushed version sync to branch: ${branchName}`);

  // Create PR using GitHub CLI
  try {
    const prTitle = `chore: sync package.json version to ${version}`;
    const prBody = `## Version Sync

This PR automatically syncs the package.json version with the newly created Git tag.

- **Tag:** ${tag}
- **Version:** ${version}
- **Trigger:** Automated by tag creation workflow

### Changes
- Updates package.json version from ${currentVersion} to ${version}

### Auto-Merge
This PR will auto-merge once all required checks pass, as it's a simple version synchronization.

---
*This PR was automatically created by the Sync Package Version workflow.*`;

    const prResult = exec(
      `gh pr create --title "${prTitle}" --body "${prBody}" --base main --head "${branchName}"`,
    );
    console.log(`‚úÖ Created PR: ${prResult}`);

    // Try to enable auto-merge
    try {
      exec(`gh pr merge "${branchName}" --auto --squash`);
      console.log('üéØ Auto-merge enabled for PR');
    } catch (autoMergeError) {
      console.log('‚ö†Ô∏è Could not enable auto-merge (this is normal if auto-merge is not available)');
      console.log('The auto-merge-bot workflow will handle merging after checks pass.');
    }
  } catch (error) {
    console.error('‚ùå Failed to create PR:', error.message);
    process.exit(1);
  }

  console.log('‚úÖ Version sync completed successfully!');
}

main().catch((error) => {
  console.error('‚ùå Version sync failed:', error);
  process.exit(1);
});
