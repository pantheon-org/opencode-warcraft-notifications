name: Chores ‚Äî Dependabot PR Management

# Automated Dependabot PR management: merge passing, recreate failing
on:
  schedule:
    # Run daily at 2:00 AM UTC to merge passing PRs and recreate failing ones
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      action:
        description: 'Action to perform'
        required: true
        type: choice
        options:
          - merge-passing
          - recreate-failing
          - rebase-all
          - close-stale
        default: 'merge-passing'
      max_age_days:
        description: 'Maximum age in days for stale PRs (used with close-stale)'
        required: false
        type: number
        default: 90

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  manage-dependabot-prs:
    name: Manage Dependabot PRs
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Setup GitHub CLI
        run: gh --version

      - name: Get passing Dependabot PRs
        id: passing-prs
        if: ${{ github.event_name == 'schedule' || github.event.inputs.action == 'merge-passing' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üîç Checking for passing Dependabot PRs..."
          
          # Get all open Dependabot PRs with all checks passing
          gh pr list \
            --author app/dependabot \
            --state open \
            --json number,title,headRefName,statusCheckRollup,mergeable \
            --jq '.[] | select(.statusCheckRollup != null) | select(.mergeable == "MERGEABLE") | select(.statusCheckRollup | all(.conclusion == "SUCCESS" or .conclusion == "NEUTRAL" or .conclusion == "SKIPPED")) | .number' > passing_prs.txt
          
          # Count passing PRs
          PASSING_COUNT=$(wc -l < passing_prs.txt | tr -d ' ')
          echo "passing_count=$PASSING_COUNT" >> $GITHUB_OUTPUT
          
          if [ "$PASSING_COUNT" -gt 0 ]; then
            echo "üìã Found $PASSING_COUNT passing Dependabot PR(s) ready to merge"
            cat passing_prs.txt
          else
            echo "‚úÖ No passing Dependabot PRs found"
          fi

      - name: Auto-merge passing PRs
        id: merge-prs
        if: ${{ steps.passing-prs.outputs.passing_count > 0 }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üöÄ Auto-merging passing Dependabot PRs..."
          
          MERGED=0
          FAILED=0
          
          while read -r pr_number; do
            if [ -n "$pr_number" ]; then
              PR_TITLE=$(gh pr view "$pr_number" --json title --jq '.title')
              echo "Processing PR #$pr_number: $PR_TITLE"
              
              # Squash merge the PR
              if gh pr merge "$pr_number" --squash --auto --delete-branch; then
                echo "‚úÖ Merged PR #$pr_number"
                MERGED=$((MERGED + 1))
              else
                echo "‚ùå Failed to merge PR #$pr_number"
                FAILED=$((FAILED + 1))
              fi
              
              # Sleep to avoid rate limiting
              sleep 2
            fi
          done < passing_prs.txt
          
          echo "merged_count=$MERGED" >> $GITHUB_OUTPUT
          echo "failed_count=$FAILED" >> $GITHUB_OUTPUT
          
          echo ""
          echo "üìä Summary:"
          echo "  Merged: $MERGED"
          echo "  Failed: $FAILED"

      - name: Get failing Dependabot PRs
        id: failing-prs
        if: ${{ github.event_name == 'schedule' || github.event.inputs.action == 'recreate-failing' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üîç Checking for failing Dependabot PRs..."
          
          # Get all open Dependabot PRs
          gh pr list \
            --author app/dependabot \
            --state open \
            --json number,title,headRefName,statusCheckRollup \
            --jq '.[] | select(.statusCheckRollup != null) | select(.statusCheckRollup | any(.conclusion == "FAILURE" or .conclusion == "TIMED_OUT" or .conclusion == "STARTUP_FAILURE")) | .number' > failing_prs.txt
          
          # Count failing PRs
          FAILING_COUNT=$(wc -l < failing_prs.txt | tr -d ' ')
          echo "failing_count=$FAILING_COUNT" >> $GITHUB_OUTPUT
          
          if [ "$FAILING_COUNT" -gt 0 ]; then
            echo "üìã Found $FAILING_COUNT failing Dependabot PR(s)"
            cat failing_prs.txt
          else
            echo "‚úÖ No failing Dependabot PRs found"
          fi

      - name: Recreate failing PRs
        if: ${{ steps.failing-prs.outputs.failing_count > 0 }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "‚ôªÔ∏è Recreating failing Dependabot PRs..."
          
          RECREATED=0
          FAILED=0
          
          while read -r pr_number; do
            if [ -n "$pr_number" ]; then
              echo "Processing PR #$pr_number..."
              
              # Comment to recreate the PR
              if gh pr comment "$pr_number" --body "@dependabot recreate"; then
                echo "‚úÖ Recreated PR #$pr_number"
                RECREATED=$((RECREATED + 1))
              else
                echo "‚ùå Failed to recreate PR #$pr_number"
                FAILED=$((FAILED + 1))
              fi
              
              # Sleep to avoid rate limiting
              sleep 2
            fi
          done < failing_prs.txt
          
          echo "recreated_count=$RECREATED" >> $GITHUB_OUTPUT
          echo "failed_count=$FAILED" >> $GITHUB_OUTPUT
          
          echo ""
          echo "üìä Summary:"
          echo "  Recreated: $RECREATED"
          echo "  Failed: $FAILED"

      - name: Rebase all Dependabot PRs
        if: ${{ github.event.inputs.action == 'rebase-all' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "üîÑ Rebasing all Dependabot PRs..."
          
          REBASED=0
          FAILED=0
          
          gh pr list \
            --author app/dependabot \
            --state open \
            --json number \
            --jq '.[].number' | while read -r pr_number; do
            
            if [ -n "$pr_number" ]; then
              echo "Rebasing PR #$pr_number..."
              
              if gh pr comment "$pr_number" --body "@dependabot rebase"; then
                echo "‚úÖ Rebased PR #$pr_number"
                REBASED=$((REBASED + 1))
              else
                echo "‚ùå Failed to rebase PR #$pr_number"
                FAILED=$((FAILED + 1))
              fi
              
              # Sleep to avoid rate limiting
              sleep 2
            fi
          done
          
          echo ""
          echo "üìä Summary:"
          echo "  Rebased: $REBASED"
          echo "  Failed: $FAILED"

      - name: Close stale Dependabot PRs
        if: ${{ github.event.inputs.action == 'close-stale' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MAX_AGE_DAYS: ${{ github.event.inputs.max_age_days || '90' }}
        run: |
          echo "üßπ Closing stale Dependabot PRs older than $MAX_AGE_DAYS days..."
          
          CLOSED=0
          CUTOFF_DATE=$(date -u -d "$MAX_AGE_DAYS days ago" +%Y-%m-%dT%H:%M:%SZ 2>/dev/null || date -u -v-${MAX_AGE_DAYS}d +%Y-%m-%dT%H:%M:%SZ)
          
          gh pr list \
            --author app/dependabot \
            --state open \
            --json number,createdAt,title \
            --jq --arg cutoff "$CUTOFF_DATE" '.[] | select(.createdAt < $cutoff) | .number' | while read -r pr_number; do
            
            if [ -n "$pr_number" ]; then
              PR_TITLE=$(gh pr view "$pr_number" --json title --jq '.title')
              echo "Closing stale PR #$pr_number: $PR_TITLE"
              
              if gh pr close "$pr_number" --comment "Closing stale Dependabot PR (older than $MAX_AGE_DAYS days). A new PR will be created if the dependency update is still relevant."; then
                echo "‚úÖ Closed PR #$pr_number"
                CLOSED=$((CLOSED + 1))
              else
                echo "‚ùå Failed to close PR #$pr_number"
              fi
              
              # Sleep to avoid rate limiting
              sleep 2
            fi
          done
          
          echo ""
          echo "üìä Closed $CLOSED stale PR(s)"

      - name: Create summary report
        if: always()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "# Dependabot PR Management Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Workflow:** ${{ github.workflow }}" >> $GITHUB_STEP_SUMMARY
          echo "**Run ID:** ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "**Action:** ${{ github.event.inputs.action }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Action:** Scheduled (merge-passing + recreate-failing)" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Current Status" >> $GITHUB_STEP_SUMMARY
          
          # Get all open Dependabot PRs
          TOTAL_PRS=$(gh pr list --author app/dependabot --state open --json number --jq '. | length')
          echo "**Total open Dependabot PRs:** $TOTAL_PRS" >> $GITHUB_STEP_SUMMARY
          
          # Count PRs by status
          PASSING=$(gh pr list --author app/dependabot --state open --json statusCheckRollup --jq '[.[] | select(.statusCheckRollup != null) | select(.statusCheckRollup | all(.conclusion == "SUCCESS" or .conclusion == "NEUTRAL" or .conclusion == "SKIPPED"))] | length')
          FAILING=$(gh pr list --author app/dependabot --state open --json statusCheckRollup --jq '[.[] | select(.statusCheckRollup != null) | select(.statusCheckRollup | any(.conclusion == "FAILURE" or .conclusion == "TIMED_OUT" or .conclusion == "STARTUP_FAILURE"))] | length')
          PENDING=$(gh pr list --author app/dependabot --state open --json statusCheckRollup --jq '[.[] | select(.statusCheckRollup != null) | select(.statusCheckRollup | any(.status == "IN_PROGRESS" or .status == "PENDING" or .status == "QUEUED"))] | length')
          
          echo "- ‚úÖ Passing: $PASSING" >> $GITHUB_STEP_SUMMARY
          echo "- ‚ùå Failing: $FAILING" >> $GITHUB_STEP_SUMMARY
          echo "- ‚è≥ Pending: $PENDING" >> $GITHUB_STEP_SUMMARY
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Actions Performed" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.passing-prs.outputs.passing_count }}" != "" ]; then
            echo "- Found ${{ steps.passing-prs.outputs.passing_count }} passing PR(s)" >> $GITHUB_STEP_SUMMARY
            if [ "${{ steps.merge-prs.outputs.merged_count }}" != "" ]; then
              echo "- ‚úÖ Auto-merged ${{ steps.merge-prs.outputs.merged_count }} PR(s)" >> $GITHUB_STEP_SUMMARY
              if [ "${{ steps.merge-prs.outputs.failed_count }}" != "0" ]; then
                echo "- ‚ùå Failed to merge ${{ steps.merge-prs.outputs.failed_count }} PR(s)" >> $GITHUB_STEP_SUMMARY
              fi
            fi
          fi
          
          if [ "${{ steps.failing-prs.outputs.failing_count }}" != "" ]; then
            echo "- Found ${{ steps.failing-prs.outputs.failing_count }} failing PR(s)" >> $GITHUB_STEP_SUMMARY
            if [ "${{ steps.failing-prs.outputs.failing_count }}" != "0" ]; then
              echo "- ‚ôªÔ∏è Recreated failing PRs" >> $GITHUB_STEP_SUMMARY
            fi
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "*This workflow runs daily at 2:00 AM UTC to auto-merge passing PRs and recreate failing ones.*" >> $GITHUB_STEP_SUMMARY

      - name: Create issue on persistent failures
        if: failure()
        uses: actions/github-script@f28e40c7f34bde8b3046d885e986cb6290c5673b # v7.1.0
        with:
          script: |
            const { owner, repo } = context.repo;
            const label = 'dependabot-management';
            const title = '‚ö†Ô∏è Dependabot PR Management Failed';
            
            // Check for existing open issues with the label
            const { data: issues } = await github.rest.issues.listForRepo({
              owner,
              repo,
              state: 'open',
              labels: label
            });
            
            const existingIssue = issues.find(issue => 
              issue.title.includes('Dependabot PR Management Failed')
            );
            
            if (existingIssue) {
              console.log(`Issue already exists: #${existingIssue.number}`);
              
              // Add comment to existing issue
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: existingIssue.number,
                body: `‚ùå Another failure occurred at ${new Date().toISOString()}\n\nWorkflow run: ${context.serverUrl}/${owner}/${repo}/actions/runs/${context.runId}`
              });
            } else {
              // Create new issue
              await github.rest.issues.create({
                owner,
                repo,
                title,
                labels: [label, 'automation', 'dependencies'],
                body: `## Issue

The Dependabot PR management workflow has failed.

## Details

- **Run ID:** ${context.runId}
- **Workflow:** ${context.workflow}
- **Event:** ${context.eventName}
- **Run URL:** ${context.serverUrl}/${owner}/${repo}/actions/runs/${context.runId}

## Next Steps

1. Review the workflow run logs
2. Check GitHub API rate limits
3. Verify GITHUB_TOKEN permissions
4. Manually trigger the workflow with different options

## Manual Commands

You can also manage Dependabot PRs manually:

\`\`\`bash
# Rebase all Dependabot PRs
gh pr list --author app/dependabot --json number --jq '.[].number' | \\
  while read pr; do gh pr comment "$pr" --body "@dependabot rebase"; done

# Recreate failing PRs
gh pr list --author app/dependabot --json number,statusCheckRollup --jq \\
  '.[] | select(.statusCheckRollup | any(.conclusion == "FAILURE")) | .number' | \\
  while read pr; do gh pr comment "$pr" --body "@dependabot recreate"; done
\`\`\`

---

*This issue was automatically created by the Dependabot PR Management workflow.*
`
              });
            }

      - name: Final status
        if: always()
        run: |
          echo ""
          echo "üìä Dependabot PR Management Workflow Complete"
          echo ""
          echo "üîÑ Workflow Details:"
          echo "  Event: ${{ github.event_name }}"
          echo "  Run ID: ${{ github.run_id }}"
          echo "  Run URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo ""
          echo "üìö For more information:"
          echo "  - View all PRs: gh pr list --author app/dependabot"
          echo "  - Manual rebase: gh pr comment <PR#> --body '@dependabot rebase'"
          echo "  - Manual recreate: gh pr comment <PR#> --body '@dependabot recreate'"
