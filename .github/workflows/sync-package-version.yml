name: Sync Package Version

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  pull-requests: write

jobs:
  sync-package-version:
    name: Sync package.json version with tag
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Extract version from tag
        id: version
        run: |
          TAG=${GITHUB_REF#refs/tags/}
          VERSION=${TAG#v}
          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Extracted version: $VERSION from tag: $TAG"

      - name: Check if package.json needs update
        id: check
        run: |
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          TAG_VERSION="${{ steps.version.outputs.version }}"
          
          echo "Current package.json version: $CURRENT_VERSION"
          echo "Tag version: $TAG_VERSION"
          
          if [ "$CURRENT_VERSION" = "$TAG_VERSION" ]; then
            echo "needs_update=false" >> $GITHUB_OUTPUT
            echo "‚úÖ Package.json version already matches tag version"
          else
            echo "needs_update=true" >> $GITHUB_OUTPUT
            echo "üì¶ Package.json needs version update: $CURRENT_VERSION ‚Üí $TAG_VERSION"
          fi

      - name: Configure Git
        if: steps.check.outputs.needs_update == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

      - name: Create version sync branch
        if: steps.check.outputs.needs_update == 'true'
        id: branch
        run: |
          BRANCH_NAME="sync-version/${{ steps.version.outputs.tag }}"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          
          git checkout -b "$BRANCH_NAME"
          echo "Created branch: $BRANCH_NAME"

      - name: Update package.json version
        if: steps.check.outputs.needs_update == 'true'
        run: |
          NEW_VERSION="${{ steps.version.outputs.version }}"
          
          # Update package.json version using Node.js
          node -e "
            const fs = require('fs');
            const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
            pkg.version = '$NEW_VERSION';
            fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2) + '\n');
            console.log('Updated package.json version to:', pkg.version);
          "

      - name: Commit and push version sync
        if: steps.check.outputs.needs_update == 'true'
        run: |
          TAG_VERSION="${{ steps.version.outputs.version }}"
          BRANCH_NAME="${{ steps.branch.outputs.branch_name }}"
          
          git add package.json
          git commit -m "chore: sync package.json version to $TAG_VERSION

          Automatically generated by tag ${{ steps.version.outputs.tag }}
          
          [skip ci]"
          
          git push origin "$BRANCH_NAME"
          echo "Pushed version sync to branch: $BRANCH_NAME"

      - name: Create auto-merge PR
        if: steps.check.outputs.needs_update == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const tagVersion = '${{ steps.version.outputs.version }}';
            const tag = '${{ steps.version.outputs.tag }}';
            const branchName = '${{ steps.branch.outputs.branch_name }}';
            
            // Create the pull request
            const { data: pr } = await github.rest.pulls.create({
              owner,
              repo,
              title: `chore: sync package.json version to ${tagVersion}`,
              head: branchName,
              base: 'main',
              body: `## Version Sync

              This PR automatically syncs the \`package.json\` version with the newly created Git tag.

              - **Tag:** \`${tag}\`
              - **Version:** \`${tagVersion}\`
              - **Trigger:** Automated by tag creation workflow

              ### Changes
              - Updates \`package.json\` version from previous version to \`${tagVersion}\`

              ### Auto-Merge
              This PR will auto-merge once all required checks pass, as it's a simple version synchronization.

              ---
              *This PR was automatically created by the Sync Package Version workflow.*`,
              draft: false
            });

            console.log(\`Created PR #\${pr.number}: \${pr.html_url}\`);

            // Enable auto-merge if available
            try {
              await github.rest.pulls.merge({
                owner,
                repo,
                pull_number: pr.number,
                commit_title: \`chore: sync package.json version to \${tagVersion}\`,
                commit_message: \`Sync package.json version with tag \${tag}\\n\\n[skip ci]\`,
                merge_method: 'squash'
              });
              console.log(\`‚úÖ Successfully auto-merged PR #\${pr.number}\`);
            } catch (error) {
              console.log(\`‚ö†Ô∏è Could not auto-merge PR #\${pr.number}: \${error.message}\`);
              console.log('PR created and waiting for manual merge or status checks to complete.');
              
              // Try to enable auto-merge for when checks pass
              try {
                const mutation = \`
                  mutation(\$pullRequestId: ID!, \$mergeMethod: PullRequestMergeMethod!) {
                    enablePullRequestAutoMerge(input: {
                      pullRequestId: \$pullRequestId,
                      mergeMethod: \$mergeMethod
                    }) {
                      pullRequest {
                        autoMergeRequest {
                          enabledAt
                        }
                      }
                    }
                  }
                \`;
                await github.graphql(mutation, {
                  pullRequestId: pr.node_id,
                  mergeMethod: 'SQUASH'
                });
                console.log(\`‚úÖ Enabled auto-merge for PR #\${pr.number}\`);
              } catch (autoMergeError) {
                console.log(\`‚ö†Ô∏è Could not enable auto-merge: \${autoMergeError.message}\`);
              }
            }

      - name: Skip if no update needed
        if: steps.check.outputs.needs_update == 'false'
        run: |
          echo "‚úÖ Package.json version already matches tag version - no sync needed"
          echo "Current workflow completed successfully with no changes required."