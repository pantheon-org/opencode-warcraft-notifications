name: Sync Package Version

on:
  push:
    tags:
      - 'v*'
  # Add a manual trigger for testing
  workflow_dispatch:
    inputs:
      tag:
        description: 'Tag to sync (e.g., v1.2.3)'
        required: true
        type: string

permissions:
  contents: write
  pull-requests: write
  actions: write
  checks: write

concurrency:
  group: sync-version-${{ github.ref }}
  cancel-in-progress: false

jobs:
  check-sync-needed:
    name: Check if version sync is needed
    runs-on: ubuntu-latest
    outputs:
      sync_needed: ${{ steps.check.outputs.sync_needed }}
      tag_version: ${{ steps.check.outputs.tag_version }}
      package_version: ${{ steps.check.outputs.package_version }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Check if sync is needed
        id: check
        run: |
          # Extract tag and version
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            TAG="${{ github.event.inputs.tag }}"
          else
            TAG=${GITHUB_REF#refs/tags/}
          fi
          
          VERSION=${TAG#v}
          echo "tag_version=$VERSION" >> $GITHUB_OUTPUT
          
          # Get current package.json version
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          echo "package_version=$PACKAGE_VERSION" >> $GITHUB_OUTPUT
          
          echo "ðŸ·ï¸ Tag version: $VERSION"
          echo "ðŸ“¦ Package.json version: $PACKAGE_VERSION"
          
          if [ "$PACKAGE_VERSION" = "$VERSION" ]; then
            echo "âœ… Package.json version already matches tag - no sync needed"
            echo "sync_needed=false" >> $GITHUB_OUTPUT
          else
            echo "ðŸ“¦ Package.json needs sync (legacy mode)"
            echo "sync_needed=true" >> $GITHUB_OUTPUT
          fi

  sync-package-version:
    name: Sync package.json version with tag (Legacy Mode)
    runs-on: ubuntu-latest
    needs: check-sync-needed
    if: needs.check-sync-needed.outputs.sync_needed == 'true'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.WORKFLOW_PAT || secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Run version sync script
        env:
          GITHUB_TOKEN: ${{ secrets.WORKFLOW_PAT || secrets.GITHUB_TOKEN }}
          TARGET_VERSION: ${{ needs.check-sync-needed.outputs.tag_version }}
          CURRENT_VERSION: ${{ needs.check-sync-needed.outputs.package_version }}
        run: |
          echo "ðŸ”„ Running legacy version sync..."
          echo "ðŸ“¦ Current: $CURRENT_VERSION â†’ Target: $TARGET_VERSION"
          node .github/scripts/sync-version.cjs